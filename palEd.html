<html>
<head>
<meta charset="UTF-8">
<title>Palettieditori</title>
<style>
  body {
    padding: 10px;
  }
  h1 {
    margin-left: 20px;
  }
  .intro {
    margin-left: 20px;
    font-weight: bold;
  }
  div {
    margin: 10px;
    border: 1px solid black;
    padding: 10px;
  }
  button {
    background-color: blue;
    color: white;
  }
  input {
    font-family: monospace;
    font-size: 12px;
  }
  #editor input {
    text-align: right;
  }
  #editor table {
    border-collapse: collapse;
    margin: 10px;
    border: 1px solid black;
  }
  #editor th {
    border: 1px solid black;
    padding: 5px;
  }
  #editor td {
    padding: 15px 5px;
  }
  #editor td input {
    border: none;
  }
  #editor .v {
  }
  #editor .h {
    display: none;
  }
</style>
</head>
<body>
<h1>Palettieditori</h1>
<p class="intro">T&#xE4;ll&#xE4; sivulla voit luoda ja muokata yksikertaisia
RIFF-palettitiedostoja.</p>
<div style="display:none">
  <input id="fileInput" type="file">
  <a id="download" href="data:," download="--roska--"></a>
</div>
<div style="border: 1px solid black; padding: 10px; margin 20px;">
  <p><button id="load" style="border: 1px solid black;">Avaa ...</button>
  <input id="name" type="text" size="40" value="uusi.pal">
  <button id="save" style="border: 1px solid black;">Tallenna</button></p>
</div>
<div id="editor">
Paletin koko: <input id="palettesize" type="text" size="4"/>
<table id="palette">
<tr id="headrow"><th></th><th class="colhead">0</th></tr>
<tr class="datarow V">
<th>0</th><td class="datacell">
<input type="text" size="6" id="i0"></td>
</tr>
</table>
</div>
<script>

(function () {

  var palette = [
    0x000000,0x0000AA,0x00AA00,0x00AAAA, 0xAA0000,0xAA00AA,0xAA5500,0xAAAAAA,
    0x555555,0x5555FF,0x55FF55,0x55FFFF, 0xFF5555,0xFF55FF,0xFFFF55,0xFFFFFF,
    0x000000,0x111111,0x222222,0x333333, 0x444444,0x555555,0x666666,0x777777,
    0x888888,0x999999,0xAAAAAA,0xBBBBBB, 0xCCCCCC,0xDDDDDD,0xEEEEEE,0xFFFFFF,
    0x0000FF,0x4100FF,0x8200FF,0xBE00FF, 0xFF00FF,0xFF00BE,0xFF0082,0xFF0041,
    0xFF0000,0xFF4100,0xFF8200,0xFFBE00, 0xFFFF00,0xBEFF00,0x82FF00,0x41FF00,
    0x00FF00,0x00FF41,0x00FF82,0x00FFBE, 0x00FFFF,0x00BEFF,0x0082FF,0x0041FF,
    0x8282FF,0x9E82FF,0xBE82FF,0xDF82FF, 0xFF82FF,0xFF82DF,0xFF82BE,0xFF829E,
    0xFF8282,0xFF9E82,0xFFBE82,0xFFDF82, 0xFFFF82,0xDFFF82,0xBEFF82,0x9EFF82,
    0x82FF82,0x82FF9E,0x82FFBE,0x82FFDF, 0x82FFFF,0x82DFFF,0x82BEFF,0x829EFF,
    0xBABAFF,0xCABAFF,0xDFBAFF,0xEFBAFF, 0xFFBAFF,0xFFBAEF,0xFFBADF,0xFFBACA,
    0xFFBABA,0xFFCABA,0xFFDFBA,0xFFEFBA, 0xFFFFBA,0xEFFFBA,0xDFFFBA,0xCAFFBA,
    0xBAFFBA,0xBAFFCA,0xBAFFDF,0xBAFFEF, 0xBAFFFF,0xBAEFFF,0xBADFFF,0xBACAFF,
    0x000071,0x1C0071,0x390071,0x550071, 0x710071,0x710055,0x710039,0x71001C,
    0x710000,0x711C00,0x713900,0x715500, 0x717100,0x557100,0x397100,0x1C7100,
    0x007100,0x00711C,0x007139,0x007155, 0x007171,0x005571,0x003971,0x001C71,
    0x393971,0x453971,0x553971,0x613971, 0x713971,0x713961,0x713955,0x713945,
    0x713939,0x714539,0x715539,0x716139, 0x717139,0x617139,0x557139,0x457139,
    0x397139,0x397145,0x397155,0x397161, 0x397171,0x396171,0x395571,0x394571,
    0x515171,0x595171,0x615171,0x695171, 0x715171,0x715169,0x715161,0x715159,
    0x715151,0x715951,0x716151,0x716951, 0x717151,0x697151,0x617151,0x597151,
    0x517151,0x517159,0x517161,0x517169, 0x517171,0x516971,0x516171,0x515971,
    0x000041,0x100041,0x200041,0x310041, 0x410041,0x410031,0x410020,0x410010,
    0x410000,0x411000,0x412000,0x413100, 0x414100,0x314100,0x204100,0x104100,
    0x004100,0x004110,0x004120,0x004131, 0x004141,0x003141,0x002041,0x001041,
    0x202041,0x282041,0x312041,0x392041, 0x412041,0x412039,0x412031,0x412028,
    0x412020,0x412820,0x413120,0x413920, 0x414120,0x394120,0x314120,0x284120,
    0x204120,0x204128,0x204131,0x204139, 0x204141,0x203941,0x203141,0x202841,
    0x2D2D41,0x312D41,0x352D41,0x3D2D41, 0x412D41,0x412D3D,0x412D35,0x412D31,
    0x412D2D,0x41312D,0x41352D,0x413D2D, 0x41412D,0x3D412D,0x35412D,0x31412D,
    0x2D412D,0x2D4131,0x2D4135,0x2D413D, 0x2D4141,0x2D3D41,0x2D3541,0x2D3141,
    0x000000,0x0000FF,0x00FF00,0x00FFFF, 0xFF0000,0xFF00FF,0xFFFF00,0xFFFFFF ];

  var paletteSize = 16;

  var PALETTESIZE = document.getElementById("palettesize");
  PALETTESIZE.onchange = resizePalette;

  var PALETTE = document.getElementById("palette");

  var HEADROW = document.getElementById("headrow");
  var HEADCELLS = HEADROW.getElementsByClassName("colhead");

  var DATAROWS = PALETTE.getElementsByClassName("datarow");

  function resizePalette() {
    var newSize = Number(PALETTESIZE.value);
    if (isNaN(newSize) || !newSize) {
      PALETTESIZE.value = paletteSize;
      return;
    }
    if (newSize > 256) newSize = 256;
    paletteSize = newSize;
    showPalette();
  }

  function showPalette() {
    PALETTESIZE.value = paletteSize;
    var rowCnt = Math.ceil(paletteSize / 16);
    var colCnt = (paletteSize < 16 ? paletteSize : 16);
    for (var col = 0; col < 16; col++) {
      var TH = HEADCELLS[col];
      if (col < colCnt) {
        if (!TH) {
          TH = document.createElement("th");
          TH.innerHTML = formatHex(col, 1);
          HEADROW.appendChild(TH);
        }
        TH.className = "colhead v";
      } else {
        if (TH) {
          TH.className = "colhead h";
        }
      }
    }
    for (var row = 0; row < 16; row++) {
      var ROW = DATAROWS[row];
      if (row < rowCnt) {
        if (!ROW) {
          ROW = document.createElement("tr");
          PALETTE.appendChild(ROW);
          var TH = document.createElement("th");
          ROW.appendChild(TH);
          TH.innerHTML = formatHex(row, 1);
        }
        var CELLS = ROW.getElementsByTagName("td");
        for (var col = 0; col < 16; col++) {
          var xin = 16 * row + col;
          var TD = CELLS[col];
          if (xin < paletteSize) {
            if (!TD) {
              TD = document.createElement("td");
              ROW.appendChild(TD);
            }
            var INPUT = TD.getElementsByTagName("input")[0];
            if (!INPUT) {
              INPUT = document.createElement("input");
              TD.appendChild(INPUT);
              INPUT.id = "i"+xin;
              INPUT.type = "text";
              INPUT.size = 6;
              INPUT.oninput = recolor;
              INPUT.onchange = recolor;
            }
            var color = formatHex(palette[xin], 6);
            INPUT.value = color;
            TD.style.backgroundColor = "#"+color;
            TD.className = "datacell v";
          } else {
            if (TD) {
              TD.className = "datacell h";
            }
          }
        }
        ROW.className = "datarow v";
      } else {
        if (ROW) {
          ROW.className = "datarow h";
        }
      }
    }
  }

  showPalette();

  function recolor(event) {
    var xin = Number(this.id.substr(1));
    var img = this.value;
    var pos = this.selectionStart - img.length;
    if (pos > 6) pos = 6;
    var newVal = Number("0x"+img);
    if (isNaN(newVal)) {
      newVal = palette[xin];
    }
    var newImg = formatHex(newVal, 6);
    var newImgLen = newImg.length;
    this.value = newImg;
    pos = pos + newImg.length;
    this.setSelectionRange(pos, pos);
    this.parentElement.style.backgroundColor = "#"+newImg;
    palette[xin] = newVal;
  }

  function formatHex(value, width) {
    var img = value.toString(16).toUpperCase();
    img = ("000000000000000" + img).substr(-width);
    return img;
  }

  function readChars(data, pos, len) {
    var ans = [];
    for (var i = 0; i < len && pos + i < data.length; i++) {
      ans[i] = data.charAt(pos + i);
    }
    return ans.join('');
  }

  function readInt(data, pos, len) {
    var ans = 0;
    for (var i = 0; i < len && pos + i < data.length; i++) {
      ans = ans + ((1 << (8 * i)) * data.charCodeAt(pos + i));
    }
    return ans;
  }

  var NAME = document.getElementById("name");
  var CONTENT = document.getElementById("content");

  var FILEINPUT = document.getElementById("fileInput");

  var reader = new FileReader();

  FILEINPUT.onchange = function() {
    if (busy) {
      alert("Yrit\u00E4 uudelleen my\u00F6hemmin");
      busy = false;
      return;
    }
    busy = true;
    var NAME = document.getElementById("name");
    var files = FILEINPUT.files;
    if (files.length == 0) {
      NAME.innerHTML = "<i>No file</i>";
      return;
    }
    var myFile = files[0];
    NAME.value = myFile.name;
    reader.onload = function() {
      var data = reader.result;
      var dump = "";
      var signature = readChars(data, 0, 4);
      var filelength = readInt(data, 4, 4);
      var filetype = readChars(data, 8, 4);
      var chunkpos = 12;
      var datapos = 0;
      var datacnt = 0;
      while (chunkpos < data.length && datapos == 0) {
        var chunktype = readChars(data, chunkpos, 4);
        var chunksize = readInt(data, chunkpos + 4, 4);
        if (chunktype == "data") {
          datacnt = readInt(data, chunkpos + 10, 2);
          datapos = chunkpos + 12;
        }
        chunkpos = chunkpos + 8 + chunksize;
        if (chunkpos % 2 != 0) chunkpos++;
      }
      if (signature != "RIFF" || filetype != "PAL " || datapos == 0) {
        alert("Ei ole RIFF-palettitiedosto");
        busy = false;
        return;
      }
      for (var xin = 0; xin < datacnt; xin++) {
        var pos = datapos + 4 * xin;
        palette[xin] = (readInt(data, pos, 1) << 16)
                     + (readInt(data, pos+1, 1) << 8)
                     + (readInt(data, pos+2, 1));
      }
      paletteSize = datacnt;
      showPalette();
      busy = false;
    };
    reader.onloadend = function () {
      busy = false;
    }
    reader.readAsBinaryString(myFile);
  }

  var LOAD = document.getElementById("load");
  var busy = false;
  LOAD.onmousedown = function() {
    if (!busy) {
      FILEINPUT.click();
    } else {
      alert("Yrit\u00E4 uudelleen my\u00F6hemmin");
      busy = false;
    }
  }

  var content = [];

  var b64 = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";

  function encodeContent() {
    var ans = ['data:image/image/vnd.zbrush.pcx;base64,'];
    for (var p = 0; p < content.length; p = p + 3) {
      ans.push(b64[(content[p] & 0xFC) >> 2]);
      if (p + 1 < content.length) {
        ans.push(b64[((content[p] & 0x03) << 4)|((content[p+1] & 0xF0) >> 4)]);
        if (p + 2 < content.length) {
          ans.push(b64[ ((content[p+1] & 0x0F) << 2)
                      | ((content[p+2] & 0xC0) >> 6) ]);
          ans.push(b64[content[p+2] & 0x3F]);
        } else {
          ans.push(b64[((content[p+1] & 0x0F) << 2)]);
          ans.push('=');
        }
      } else {
        ans.push(b64[((content[p] & 0x03) << 4)]);
        ans.push('=');
        ans.push('=');
      }
    }
    return ans.join('');
  }

  function putChars(chars) {
    for (var i = 0; i < chars.length; i++) {
      content.push(chars.charCodeAt(i) & 0xFF);
    }
  }

  function putInt(val, len) {
    var more = val;
    for (var i = 0; i < len; i++) {
      content.push(more & 0xFF);
      more = more >> 8;
    }
  }

  function encodeFile() {
    content = [];
    putChars("RIFF");
    putInt(16 + 4 * paletteSize, 4);
    putChars("PAL ");
    putChars("data");
    putInt(4 + 4 * paletteSize, 4);
    putInt(0x0300, 2);
    putInt(paletteSize, 2);
    for (var xin = 0; xin < paletteSize; xin++) {
      var color = palette[xin];
      putInt((color >> 16) & 0xFF, 1);
      putInt((color >> 8) & 0xFF, 1);
      putInt(color & 0xFF, 1);
      putInt(0, 1);
    }
    return encodeContent();
  }

  var DOWNLOAD = document.getElementById("download");

  var SAVE = document.getElementById("save");

  SAVE.onmousedown = function () {
      DOWNLOAD.href = encodeFile();
      DOWNLOAD.download = NAME.value;
      DOWNLOAD.click();
  };

}) () ;
</script>
</body>
</html>
