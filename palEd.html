<html>
<head>
<meta charset="UTF-8">
<title>Palettieditori</title>
<style>
  body {
    padding: 10px;
  }
  h1 {
    margin-left: 20px;
  }
  .intro {
    margin-left: 20px;
    font-weight: bold;
  }
  div {
    margin: 10px;
    border: 1px solid black;
    padding: 10px;
  }
  button {
    background-color: blue;
    color: white;
  }
  input {
    font-family: monospace;
    font-size: 12px;
  }
  #paletteEditor input {
    text-align: center;
  }
  #paletteEditor table {
    border-collapse: collapse;
    margin: 10px;
    border: 1px solid black;
  }
  #paletteEditor th {
    border: 1px solid black;
    padding: 5px;
  }
  #paletteEditor td {
    padding: 15px 5px;
  }
  #paletteEditor td input {
    border: none;
  }
  #paletteEditor .v {
  }
  #paletteEditor .h {
    display: none;
  }
</style>
</head>
<body>
<h1>Palettieditori</h1>
<p class="intro">T&#xE4;ll&#xE4; sivulla voit luoda ja muokata yksikertaisia
RIFF-palettitiedostoja.</p>
<div style="display:none">
  <input id="fileInput" type="file">
  <a id="download" href="data:," download="--roska--"></a>
</div>
<div style="border: 1px solid black; padding: 10px; margin 20px;">
  <p><button id="paletteLoad" style="border: 1px solid black;">Avaa ...</button>
  <input id="paletteName" type="text" size="40" value="uusi.pal">
  <button id="paletteSave" style="border: 1px solid black;">Tallenna</button></p>
</div>
<div id="paletteEditor">
Paletin koko: <input id="palettesize" type="text" size="4"/>
<table id= "palette" style="z-index: -1">
<tr id="paletteHeadRow">
<th></th>
<th id="pch0" class="paletteColHead">0</th>
<th id="pch1" class="paletteColHead">1</th>
<th id="pch2" class="paletteColHead">2</th>
<th id="pch3" class="paletteColHead">3</th>
<th id="pch4" class="paletteColHead">4</th>
<th id="pch5" class="paletteColHead">5</th>
<th id="pch6" class="paletteColHead">6</th>
<th id="pch7" class="paletteColHead">7</th>
<th id="pch8" class="paletteColHead">8</th>
<th id="pch9" class="paletteColHead">9</th>
<th id="pchA" class="paletteColHead">A</th>
<th id="pchB" class="paletteColHead">B</th>
<th id="pchC" class="paletteColHead">C</th>
<th id="pchD" class="paletteColHead">D</th>
<th id="pchE" class="paletteColHead">E</th>
<th id="pchF" class="paletteColHead">F</th>
</tr>
<tr id="pr0" class="paletteDataRow">
<th id="prh0">0</th>
<td id="pd00"><input type="text" size="6"></td>
<td id="pd01"><input type="text" size="6"></td>
<td id="pd02"><input type="text" size="6"></td>
<td id="pd03"><input type="text" size="6"></td>
<td id="pd04"><input type="text" size="6"></td>
<td id="pd05"><input type="text" size="6"></td>
<td id="pd06"><input type="text" size="6"></td>
<td id="pd07"><input type="text" size="6"></td>
<td id="pd08"><input type="text" size="6"></td>
<td id="pd09"><input type="text" size="6"></td>
<td id="pd0A"><input type="text" size="6"></td>
<td id="pd0B"><input type="text" size="6"></td>
<td id="pd0C"><input type="text" size="6"></td>
<td id="pd0D"><input type="text" size="6"></td>
<td id="pd0E"><input type="text" size="6"></td>
<td id="pd0F"><input type="text" size="6"></td>
</tr>
<tr id="pr1" class="paletteDataRow">
<th id="prh1">1</th>
<td id="pd10"><input type="text" size="6"></td>
<td id="pd11"><input type="text" size="6"></td>
<td id="pd12"><input type="text" size="6"></td>
<td id="pd13"><input type="text" size="6"></td>
<td id="pd14"><input type="text" size="6"></td>
<td id="pd15"><input type="text" size="6"></td>
<td id="pd16"><input type="text" size="6"></td>
<td id="pd17"><input type="text" size="6"></td>
<td id="pd18"><input type="text" size="6"></td>
<td id="pd19"><input type="text" size="6"></td>
<td id="pd1A"><input type="text" size="6"></td>
<td id="pd1B"><input type="text" size="6"></td>
<td id="pd1C"><input type="text" size="6"></td>
<td id="pd1D"><input type="text" size="6"></td>
<td id="pd1E"><input type="text" size="6"></td>
<td id="pd1F"><input type="text" size="6"></td>
</tr>
<tr id="pr2" class="paletteDataRow">
<th id="prh2">2</th>
<td id="pd20"><input type="text" size="6"></td>
<td id="pd21"><input type="text" size="6"></td>
<td id="pd22"><input type="text" size="6"></td>
<td id="pd23"><input type="text" size="6"></td>
<td id="pd24"><input type="text" size="6"></td>
<td id="pd25"><input type="text" size="6"></td>
<td id="pd26"><input type="text" size="6"></td>
<td id="pd27"><input type="text" size="6"></td>
<td id="pd28"><input type="text" size="6"></td>
<td id="pd29"><input type="text" size="6"></td>
<td id="pd2A"><input type="text" size="6"></td>
<td id="pd2B"><input type="text" size="6"></td>
<td id="pd2C"><input type="text" size="6"></td>
<td id="pd2D"><input type="text" size="6"></td>
<td id="pd2E"><input type="text" size="6"></td>
<td id="pd2F"><input type="text" size="6"></td>
</tr>
<tr id="pr3" class="paletteDataRow">
<th id="prh3">3</th>
<td id="pd30"><input type="text" size="6"></td>
<td id="pd31"><input type="text" size="6"></td>
<td id="pd32"><input type="text" size="6"></td>
<td id="pd33"><input type="text" size="6"></td>
<td id="pd34"><input type="text" size="6"></td>
<td id="pd35"><input type="text" size="6"></td>
<td id="pd36"><input type="text" size="6"></td>
<td id="pd37"><input type="text" size="6"></td>
<td id="pd38"><input type="text" size="6"></td>
<td id="pd39"><input type="text" size="6"></td>
<td id="pd3A"><input type="text" size="6"></td>
<td id="pd3B"><input type="text" size="6"></td>
<td id="pd3C"><input type="text" size="6"></td>
<td id="pd3D"><input type="text" size="6"></td>
<td id="pd3E"><input type="text" size="6"></td>
<td id="pd3F"><input type="text" size="6"></td>
</tr>
<tr id="pr4" class="paletteDataRow">
<th id="prh4">4</th>
<td id="pd40"><input type="text" size="6"></td>
<td id="pd41"><input type="text" size="6"></td>
<td id="pd42"><input type="text" size="6"></td>
<td id="pd43"><input type="text" size="6"></td>
<td id="pd44"><input type="text" size="6"></td>
<td id="pd45"><input type="text" size="6"></td>
<td id="pd46"><input type="text" size="6"></td>
<td id="pd47"><input type="text" size="6"></td>
<td id="pd48"><input type="text" size="6"></td>
<td id="pd49"><input type="text" size="6"></td>
<td id="pd4A"><input type="text" size="6"></td>
<td id="pd4B"><input type="text" size="6"></td>
<td id="pd4C"><input type="text" size="6"></td>
<td id="pd4D"><input type="text" size="6"></td>
<td id="pd4E"><input type="text" size="6"></td>
<td id="pd4F"><input type="text" size="6"></td>
</tr>
<tr id="pr5" class="paletteDataRow">
<th id="prh5">5</th>
<td id="pd50"><input type="text" size="6"></td>
<td id="pd51"><input type="text" size="6"></td>
<td id="pd52"><input type="text" size="6"></td>
<td id="pd53"><input type="text" size="6"></td>
<td id="pd54"><input type="text" size="6"></td>
<td id="pd55"><input type="text" size="6"></td>
<td id="pd56"><input type="text" size="6"></td>
<td id="pd57"><input type="text" size="6"></td>
<td id="pd58"><input type="text" size="6"></td>
<td id="pd59"><input type="text" size="6"></td>
<td id="pd5A"><input type="text" size="6"></td>
<td id="pd5B"><input type="text" size="6"></td>
<td id="pd5C"><input type="text" size="6"></td>
<td id="pd5D"><input type="text" size="6"></td>
<td id="pd5E"><input type="text" size="6"></td>
<td id="pd5F"><input type="text" size="6"></td>
</tr>
<tr id="pr6" class="paletteDataRow">
<th id="prh6">6</th>
<td id="pd60"><input type="text" size="6"></td>
<td id="pd61"><input type="text" size="6"></td>
<td id="pd62"><input type="text" size="6"></td>
<td id="pd63"><input type="text" size="6"></td>
<td id="pd64"><input type="text" size="6"></td>
<td id="pd65"><input type="text" size="6"></td>
<td id="pd66"><input type="text" size="6"></td>
<td id="pd67"><input type="text" size="6"></td>
<td id="pd68"><input type="text" size="6"></td>
<td id="pd69"><input type="text" size="6"></td>
<td id="pd6A"><input type="text" size="6"></td>
<td id="pd6B"><input type="text" size="6"></td>
<td id="pd6C"><input type="text" size="6"></td>
<td id="pd6D"><input type="text" size="6"></td>
<td id="pd6E"><input type="text" size="6"></td>
<td id="pd6F"><input type="text" size="6"></td>
</tr>
<tr id="pr7" class="paletteDataRow">
<th id="prh7">7</th>
<td id="pd70"><input type="text" size="6"></td>
<td id="pd71"><input type="text" size="6"></td>
<td id="pd72"><input type="text" size="6"></td>
<td id="pd73"><input type="text" size="6"></td>
<td id="pd74"><input type="text" size="6"></td>
<td id="pd75"><input type="text" size="6"></td>
<td id="pd76"><input type="text" size="6"></td>
<td id="pd77"><input type="text" size="6"></td>
<td id="pd78"><input type="text" size="6"></td>
<td id="pd79"><input type="text" size="6"></td>
<td id="pd7A"><input type="text" size="6"></td>
<td id="pd7B"><input type="text" size="6"></td>
<td id="pd7C"><input type="text" size="6"></td>
<td id="pd7D"><input type="text" size="6"></td>
<td id="pd7E"><input type="text" size="6"></td>
<td id="pd7F"><input type="text" size="6"></td>
</tr>
<tr id="pr8" class="paletteDataRow">
<th id="prh8">8</th>
<td id="pd80"><input type="text" size="6"></td>
<td id="pd81"><input type="text" size="6"></td>
<td id="pd82"><input type="text" size="6"></td>
<td id="pd83"><input type="text" size="6"></td>
<td id="pd84"><input type="text" size="6"></td>
<td id="pd85"><input type="text" size="6"></td>
<td id="pd86"><input type="text" size="6"></td>
<td id="pd87"><input type="text" size="6"></td>
<td id="pd88"><input type="text" size="6"></td>
<td id="pd89"><input type="text" size="6"></td>
<td id="pd8A"><input type="text" size="6"></td>
<td id="pd8B"><input type="text" size="6"></td>
<td id="pd8C"><input type="text" size="6"></td>
<td id="pd8D"><input type="text" size="6"></td>
<td id="pd8E"><input type="text" size="6"></td>
<td id="pd8F"><input type="text" size="6"></td>
</tr>
<tr id="pr9" class="paletteDataRow">
<th id="prh9">9</th>
<td id="pd90"><input type="text" size="6"></td>
<td id="pd91"><input type="text" size="6"></td>
<td id="pd92"><input type="text" size="6"></td>
<td id="pd93"><input type="text" size="6"></td>
<td id="pd94"><input type="text" size="6"></td>
<td id="pd95"><input type="text" size="6"></td>
<td id="pd96"><input type="text" size="6"></td>
<td id="pd97"><input type="text" size="6"></td>
<td id="pd98"><input type="text" size="6"></td>
<td id="pd99"><input type="text" size="6"></td>
<td id="pd9A"><input type="text" size="6"></td>
<td id="pd9B"><input type="text" size="6"></td>
<td id="pd9C"><input type="text" size="6"></td>
<td id="pd9D"><input type="text" size="6"></td>
<td id="pd9E"><input type="text" size="6"></td>
<td id="pd9F"><input type="text" size="6"></td>
</tr>
<tr id="prA" class="paletteDataRow">
<th id="prhA">A</th>
<td id="pdA0"><input type="text" size="6"></td>
<td id="pdA1"><input type="text" size="6"></td>
<td id="pdA2"><input type="text" size="6"></td>
<td id="pdA3"><input type="text" size="6"></td>
<td id="pdA4"><input type="text" size="6"></td>
<td id="pdA5"><input type="text" size="6"></td>
<td id="pdA6"><input type="text" size="6"></td>
<td id="pdA7"><input type="text" size="6"></td>
<td id="pdA8"><input type="text" size="6"></td>
<td id="pdA9"><input type="text" size="6"></td>
<td id="pdAA"><input type="text" size="6"></td>
<td id="pdAB"><input type="text" size="6"></td>
<td id="pdAC"><input type="text" size="6"></td>
<td id="pdAD"><input type="text" size="6"></td>
<td id="pdAE"><input type="text" size="6"></td>
<td id="pdAF"><input type="text" size="6"></td>
</tr>
<tr id="prB" class="paletteDataRow">
<th id="prhB">B</th>
<td id="pdB0"><input type="text" size="6"></td>
<td id="pdB1"><input type="text" size="6"></td>
<td id="pdB2"><input type="text" size="6"></td>
<td id="pdB3"><input type="text" size="6"></td>
<td id="pdB4"><input type="text" size="6"></td>
<td id="pdB5"><input type="text" size="6"></td>
<td id="pdB6"><input type="text" size="6"></td>
<td id="pdB7"><input type="text" size="6"></td>
<td id="pdB8"><input type="text" size="6"></td>
<td id="pdB9"><input type="text" size="6"></td>
<td id="pdBA"><input type="text" size="6"></td>
<td id="pdBB"><input type="text" size="6"></td>
<td id="pdBC"><input type="text" size="6"></td>
<td id="pdBD"><input type="text" size="6"></td>
<td id="pdBE"><input type="text" size="6"></td>
<td id="pdBF"><input type="text" size="6"></td>
</tr>
<tr id="prC" class="paletteDataRow">
<th id="prhC">C</th>
<td id="pdC0"><input type="text" size="6"></td>
<td id="pdC1"><input type="text" size="6"></td>
<td id="pdC2"><input type="text" size="6"></td>
<td id="pdC3"><input type="text" size="6"></td>
<td id="pdC4"><input type="text" size="6"></td>
<td id="pdC5"><input type="text" size="6"></td>
<td id="pdC6"><input type="text" size="6"></td>
<td id="pdC7"><input type="text" size="6"></td>
<td id="pdC8"><input type="text" size="6"></td>
<td id="pdC9"><input type="text" size="6"></td>
<td id="pdCA"><input type="text" size="6"></td>
<td id="pdCB"><input type="text" size="6"></td>
<td id="pdCC"><input type="text" size="6"></td>
<td id="pdCD"><input type="text" size="6"></td>
<td id="pdCE"><input type="text" size="6"></td>
<td id="pdCF"><input type="text" size="6"></td>
</tr>
<tr id="prD" class="paletteDataRow">
<th id="prhD">D</th>
<td id="pdD0"><input type="text" size="6"></td>
<td id="pdD1"><input type="text" size="6"></td>
<td id="pdD2"><input type="text" size="6"></td>
<td id="pdD3"><input type="text" size="6"></td>
<td id="pdD4"><input type="text" size="6"></td>
<td id="pdD5"><input type="text" size="6"></td>
<td id="pdD6"><input type="text" size="6"></td>
<td id="pdD7"><input type="text" size="6"></td>
<td id="pdD8"><input type="text" size="6"></td>
<td id="pdD9"><input type="text" size="6"></td>
<td id="pdDA"><input type="text" size="6"></td>
<td id="pdDB"><input type="text" size="6"></td>
<td id="pdDC"><input type="text" size="6"></td>
<td id="pdDD"><input type="text" size="6"></td>
<td id="pdDE"><input type="text" size="6"></td>
<td id="pdDF"><input type="text" size="6"></td>
</tr>
<tr id="prE" class="paletteDataRow">
<th id="prhE">E</th>
<td id="pdE0"><input type="text" size="6"></td>
<td id="pdE1"><input type="text" size="6"></td>
<td id="pdE2"><input type="text" size="6"></td>
<td id="pdE3"><input type="text" size="6"></td>
<td id="pdE4"><input type="text" size="6"></td>
<td id="pdE5"><input type="text" size="6"></td>
<td id="pdE6"><input type="text" size="6"></td>
<td id="pdE7"><input type="text" size="6"></td>
<td id="pdE8"><input type="text" size="6"></td>
<td id="pdE9"><input type="text" size="6"></td>
<td id="pdEA"><input type="text" size="6"></td>
<td id="pdEB"><input type="text" size="6"></td>
<td id="pdEC"><input type="text" size="6"></td>
<td id="pdED"><input type="text" size="6"></td>
<td id="pdEE"><input type="text" size="6"></td>
<td id="pdEF"><input type="text" size="6"></td>
</tr>
<tr id="prF" class="paletteDataRow">
<th id="prhF">F</th>
<td id="pdF0"><input type="text" size="6"></td>
<td id="pdF1"><input type="text" size="6"></td>
<td id="pdF2"><input type="text" size="6"></td>
<td id="pdF3"><input type="text" size="6"></td>
<td id="pdF4"><input type="text" size="6"></td>
<td id="pdF5"><input type="text" size="6"></td>
<td id="pdF6"><input type="text" size="6"></td>
<td id="pdF7"><input type="text" size="6"></td>
<td id="pdF8"><input type="text" size="6"></td>
<td id="pdF9"><input type="text" size="6"></td>
<td id="pdFA"><input type="text" size="6"></td>
<td id="pdFB"><input type="text" size="6"></td>
<td id="pdFC"><input type="text" size="6"></td>
<td id="pdFD"><input type="text" size="6"></td>
<td id="pdFE"><input type="text" size="6"></td>
<td id="pdFF"><input type="text" size="6"></td>
</tr>
</table>
</div>
<script>

(function () {

  var palette = [
    0x000000,0x0000AA,0x00AA00,0x00AAAA, 0xAA0000,0xAA00AA,0xAA5500,0xAAAAAA,
    0x555555,0x5555FF,0x55FF55,0x55FFFF, 0xFF5555,0xFF55FF,0xFFFF55,0xFFFFFF,
    0x000000,0x111111,0x222222,0x333333, 0x444444,0x555555,0x666666,0x777777,
    0x888888,0x999999,0xAAAAAA,0xBBBBBB, 0xCCCCCC,0xDDDDDD,0xEEEEEE,0xFFFFFF,
    0x0000FF,0x4100FF,0x8200FF,0xBE00FF, 0xFF00FF,0xFF00BE,0xFF0082,0xFF0041,
    0xFF0000,0xFF4100,0xFF8200,0xFFBE00, 0xFFFF00,0xBEFF00,0x82FF00,0x41FF00,
    0x00FF00,0x00FF41,0x00FF82,0x00FFBE, 0x00FFFF,0x00BEFF,0x0082FF,0x0041FF,
    0x8282FF,0x9E82FF,0xBE82FF,0xDF82FF, 0xFF82FF,0xFF82DF,0xFF82BE,0xFF829E,
    0xFF8282,0xFF9E82,0xFFBE82,0xFFDF82, 0xFFFF82,0xDFFF82,0xBEFF82,0x9EFF82,
    0x82FF82,0x82FF9E,0x82FFBE,0x82FFDF, 0x82FFFF,0x82DFFF,0x82BEFF,0x829EFF,
    0xBABAFF,0xCABAFF,0xDFBAFF,0xEFBAFF, 0xFFBAFF,0xFFBAEF,0xFFBADF,0xFFBACA,
    0xFFBABA,0xFFCABA,0xFFDFBA,0xFFEFBA, 0xFFFFBA,0xEFFFBA,0xDFFFBA,0xCAFFBA,
    0xBAFFBA,0xBAFFCA,0xBAFFDF,0xBAFFEF, 0xBAFFFF,0xBAEFFF,0xBADFFF,0xBACAFF,
    0x000071,0x1C0071,0x390071,0x550071, 0x710071,0x710055,0x710039,0x71001C,
    0x710000,0x711C00,0x713900,0x715500, 0x717100,0x557100,0x397100,0x1C7100,
    0x007100,0x00711C,0x007139,0x007155, 0x007171,0x005571,0x003971,0x001C71,
    0x393971,0x453971,0x553971,0x613971, 0x713971,0x713961,0x713955,0x713945,
    0x713939,0x714539,0x715539,0x716139, 0x717139,0x617139,0x557139,0x457139,
    0x397139,0x397145,0x397155,0x397161, 0x397171,0x396171,0x395571,0x394571,
    0x515171,0x595171,0x615171,0x695171, 0x715171,0x715169,0x715161,0x715159,
    0x715151,0x715951,0x716151,0x716951, 0x717151,0x697151,0x617151,0x597151,
    0x517151,0x517159,0x517161,0x517169, 0x517171,0x516971,0x516171,0x515971,
    0x000041,0x100041,0x200041,0x310041, 0x410041,0x410031,0x410020,0x410010,
    0x410000,0x411000,0x412000,0x413100, 0x414100,0x314100,0x204100,0x104100,
    0x004100,0x004110,0x004120,0x004131, 0x004141,0x003141,0x002041,0x001041,
    0x202041,0x282041,0x312041,0x392041, 0x412041,0x412039,0x412031,0x412028,
    0x412020,0x412820,0x413120,0x413920, 0x414120,0x394120,0x314120,0x284120,
    0x204120,0x204128,0x204131,0x204139, 0x204141,0x203941,0x203141,0x202841,
    0x2D2D41,0x312D41,0x352D41,0x3D2D41, 0x412D41,0x412D3D,0x412D35,0x412D31,
    0x412D2D,0x41312D,0x41352D,0x413D2D, 0x41412D,0x3D412D,0x35412D,0x31412D,
    0x2D412D,0x2D4131,0x2D4135,0x2D413D, 0x2D4141,0x2D3D41,0x2D3541,0x2D3141,
    0x000000,0x0000FF,0x00FF00,0x00FFFF, 0xFF0000,0xFF00FF,0xFFFF00,0xFFFFFF ];

  var paletteSize = 16;

  var PALETTESIZE = document.getElementById("palettesize");
  PALETTESIZE.onchange = resizePalette;

  var PALETTE = document.getElementById("palette");

  var PALETTEHEADROW = document.getElementById("paletteHeadRow");
  var PALETTEHEADCELLS
              = PALETTEHEADROW.getElementsByClassName("paletteColHead");

  var PALETTEDATAROWS = PALETTE.getElementsByClassName("paletteDataRow");
  var PALETTEDATACELLSS = [];
  var PALETTEINPUTSS = [];
  for (var row = 0; row < 16; row++) {
    PALETTEDATACELLSS[row] = PALETTEDATAROWS[row].getElementsByTagName("td");
    PALETTEINPUTSS[row] = PALETTEDATAROWS[row].getElementsByTagName("input");
    for (var col = 0; col < 16; col++) {
      var PALETTEINPUT = PALETTEINPUTSS[row][col];
      PALETTEINPUT.onfocus = recolorPaletteCell;
      PALETTEINPUT.oninput = recolorPaletteCell;
      PALETTEINPUT.onchange = recolorPaletteCell;
      PALETTEINPUT.onmouseup = recolorPaletteCell;
      PALETTEINPUT.onkeyup = recolorPaletteCell;
    }
  }

  function resizePalette() {
    var newSize = Number(PALETTESIZE.value);
    if (isNaN(newSize) || !newSize) {
      PALETTESIZE.value = paletteSize;
      return;
    }
    if (newSize > 256) newSize = 256;
    paletteSize = newSize;
    showPalette();
  }

  function showPalette() {
    PALETTESIZE.value = paletteSize;
    var rowCnt = Math.ceil(paletteSize / 16);
    var colCnt = (paletteSize < 16 ? paletteSize : 16);
    for (var col = 0; col < 16; col++) {
      var TH = PALETTEHEADCELLS[col];
      TH.className = (col < colCnt ? "paletteColHead v" : "paletteColHead h");
    }
    for (var row = 0; row < 16; row++) {
      var DATAROW = PALETTEDATAROWS[row];
      if (row < rowCnt) {
        var DATACELLS = PALETTEDATACELLSS[row];
        for (var col = 0; col < 16; col++) {
          var xin = 16 * row + col;
          var TD = DATACELLS[col];
          if (xin < paletteSize) {
            var INPUT = PALETTEINPUTSS[row][col];
            var color = formatHex(palette[xin], 6);
            INPUT.value = color;
            TD.style.backgroundColor = "#"+color;
            TD.className = "datacell v";
          } else {
            TD.className = "datacell h";
          }
        }
        DATAROW.className = "paletteDataRow v";
      } else {
        DATAROW.className = "paletteDataRow h";
      }
    }
  }

  showPalette();

  function recolorPaletteCell(event) {
    var xin = Number(this.id.substr(1));
    var startPos = this.selectionStart;
    var endPos = this.selectionEnd;
    var newVal = Number(("0x" + this.value + "000000").substr(0, 8));
    if (isNaN(newVal)) {
      newVal = palette[xin];
    }
    this.value = formatHex(newVal, 6);
    this.setSelectionRange(startPos, endPos);
    this.parentElement.style.backgroundColor = "#"+this.value;
    palette[xin] = newVal;
  }

  function formatHex(value, width) {
    var img = value.toString(16).toUpperCase();
    img = ("000000000000000" + img).substr(-width);
    return img;
  }

  function readChars(data, pos, len) {
    var ans = [];
    for (var i = 0; i < len && pos + i < data.length; i++) {
      ans[i] = data.charAt(pos + i);
    }
    return ans.join('');
  }

  function readInt(data, pos, len) {
    var ans = 0;
    for (var i = 0; i < len && pos + i < data.length; i++) {
      ans = ans + ((1 << (8 * i)) * data.charCodeAt(pos + i));
    }
    return ans;
  }

  var PALETTENAME = document.getElementById("paletteName");
//  var CONTENT = document.getElementById("content");

  var FILEINPUT = document.getElementById("fileInput");

  var reader = new FileReader();

  FILEINPUT.onchange = function() {
    if (busy) {
      alert("Yrit\u00E4 uudelleen my\u00F6hemmin");
      busy = false;
      return;
    }
    busy = true;
    var files = FILEINPUT.files;
    if (files.length == 0) {
      PALETTENAME.innerHTML = "<i>No file</i>";
      return;
    }
    var myFile = files[0];
    PALETTENAME.value = myFile.name;
    reader.onload = function() {
      var filelength, filetype, chunkpos, datapos, datacnt;
      var data = reader.result;
      var signature = readChars(data, 0, 4);
      var good = signature != "RIFF";
      if (good) {
        filelength = readInt(data, 4, 4);
        filetype = readChars(data, 8, 4);
        good = (filetype == "PAL ");
      }
      if (good) {
        chunkpos = 12;
        datapos = 0;
        datacnt = 0;
        while (chunkpos < data.length && datapos == 0) {
          var chunktype = readChars(data, chunkpos, 4);
          var chunksize = readInt(data, chunkpos + 4, 4);
          if (chunktype == "data") {
            datacnt = readInt(data, chunkpos + 10, 2);
            datapos = chunkpos + 12;
          }
          chunkpos = chunkpos + 8 + chunksize;
          if (chunkpos % 2 != 0) chunkpos++;
        }
        good = datapos > 0;
      }
      if (good) {
        for (var xin = 0; xin < datacnt; xin++) {
          var pos = datapos + 4 * xin;
          palette[xin] = (readInt(data, pos, 1) << 16)
                       + (readInt(data, pos+1, 1) << 8)
                       + (readInt(data, pos+2, 1));
        }
        paletteSize = datacnt;
        showPalette();
      }
      if (!good) {
        alert("Ei ole RIFF-palettitiedosto");
      }
      busy = false;
    };
    reader.onloadend = function () {
      busy = false;
    }
    reader.readAsBinaryString(myFile);
  }

  var LOAD = document.getElementById("paletteLoad");
  var busy = false;
  LOAD.onmousedown = function() {
    if (!busy) {
      FILEINPUT.click();
    } else {
      alert("Yrit\u00E4 uudelleen my\u00F6hemmin");
      busy = false;
    }
  }

  var content = [];

  var b64 = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";

  function encodeContent(mimetype) {
    var ans = ['data:',mimetype,';base64,'];
    for (var p = 0; p < content.length; p = p + 3) {
      ans.push(b64[(content[p] & 0xFC) >> 2]);
      if (p + 1 < content.length) {
        ans.push(b64[((content[p] & 0x03) << 4)|((content[p+1] & 0xF0) >> 4)]);
        if (p + 2 < content.length) {
          ans.push(b64[ ((content[p+1] & 0x0F) << 2)
                      | ((content[p+2] & 0xC0) >> 6) ]);
          ans.push(b64[content[p+2] & 0x3F]);
        } else {
          ans.push(b64[((content[p+1] & 0x0F) << 2)]);
          ans.push('=');
        }
      } else {
        ans.push(b64[((content[p] & 0x03) << 4)]);
        ans.push('=');
        ans.push('=');
      }
    }
    return ans.join('');
  }

  function putChars(chars) {
    for (var i = 0; i < chars.length; i++) {
      content.push(chars.charCodeAt(i) & 0xFF);
    }
  }

  function putInt(val, len) {
    var more = val;
    for (var i = 0; i < len; i++) {
      content.push(more & 0xFF);
      more = more >> 8;
    }
  }

  function encodePaletteFile() {
    content = [];
    putChars("RIFF");
    putInt(16 + 4 * paletteSize, 4);
    putChars("PAL ");
    putChars("data");
    putInt(4 + 4 * paletteSize, 4);
    putInt(0x0300, 2);
    putInt(paletteSize, 2);
    for (var xin = 0; xin < paletteSize; xin++) {
      var color = palette[xin];
      putInt((color >> 16) & 0xFF, 1);
      putInt((color >> 8) & 0xFF, 1);
      putInt(color & 0xFF, 1);
      putInt(0, 1);
    }
    return encodeContent('application/octet-stream');
  }

  var DOWNLOAD = document.getElementById("download");

  var PALETTESAVE = document.getElementById("paletteSave");

  PALETTESAVE.onmousedown = function () {
      DOWNLOAD.href = encodePaletteFile();
      DOWNLOAD.download = PALETTENAME.value;
      DOWNLOAD.click();
  };

}) () ;
</script>
</body>
</html>
